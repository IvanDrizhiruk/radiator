<!doctype html>
<html lang="ru">
<head>
<title>Activity Monitor</title>

<meta charset="utf-8">
<meta name="Author" content="Roman Burdyga, Ardas Group" />
<meta http-equiv="refresh" content="60">

<link rel="stylesheet" href="css/style.css">

<script src="js/modernizr-1.7.min.js"></script>
<script src="js/jquery-1.9.0.min.js"></script>
<script src="js/md5.min.js"></script>

<script src="js/google_jsapi.js"></script>
<script src="js/google_piechart.js"></script>

<script type="text/javascript">

		function updateRadiator() {
			var repost = $.parseJSON('${repostInJson}');
			
			processThucydidesTestsSection(repost.thucydidesTestStaistic);

			processSpiraTestStatisticSection(repost.spiraTestStatistics, repost.spiraTestOnStartWeekStatistics);
			
			processBuildStatesSection(repost.buildStates);
		}
		
		function processThucydidesTestsSection(statistics) {
			var failed = statistics.failed + statistics.errors;
			
			initFailedCount($("#failednumT"), failed);
			$("#passedlblT")[0].innerHTML = statistics.passed;
			$("#pendinglblT")[0].innerHTML = statistics.pending;

			
			drawChart(statistics.passed, statistics.pending, failed, 'thucydidesChart');
		}

		function drawChart(passed, pending, failed, holder) {
			var data = google.visualization.arrayToDataTable([
					[ 'Tests', 'Amount' ], [ , passed ], [ , pending ],
					[ , failed ] ]);

			var options = {
				width : 327,
				height : 327,
				chartArea : {
					width : "100%",
					height : "100%"
				},
				colors : [ '#00C000', '#FFB700', '#FF0000' ],
				legend : {
					position : 'none'
				},
				backgroundColor : 'none'
			};

			var chart = new google.visualization.PieChart(document.getElementById(holder));
			chart.draw(data, options);
		}
		
		function initFailedCount(element, value) {
			element[0].innerHTML = value;
			
			var color = (0 == value
							? 'gray'
							: 0 >= value
								? 'green'
								: '#e30613')
				
			element.css('background', color);
		}
		
		
		
		function processSpiraTestStatisticSection(statistics, statisticsOnWeekStart) {
			initBugSection($("#bugCriticalTitle"), $("#bugCriticalTotal"), $("#bugCriticalInfo"), statistics.high, statisticsOnWeekStart.high);
			initBugSection($("#bugHighTitle"), $("#bugHighTotal"), $("#bugHighInfo"), statistics.medium, statisticsOnWeekStart.medium);
			initBugSection($("#bugMediumTitle"), $("#bugMediumTotal"), $("#bugMediumInfo"), statistics.low, statisticsOnWeekStart.low);
		}
		
		function initBugSection(titleElement, totalElement, infoElement, totalCount, totalCountOnWeekStart) {
			

			initFailedCount(infoElement, totalCount-totalCountOnWeekStart);

			titleElement.css('color', (0 == totalCount) ? 'green' : '#e30613');
			totalElement[0].innerHTML = getNumberOrUnknownSign(totalCount);
		}

		function getNumberOrUnknownSign(num) {
			return -1 < num ? num : "?";
		}

		function processBuildStatesSection(states) {
			var isBuildFailed = true;
			var lastCommitter = "Ivan Drizhiruk";
			var lastCommitterEmail = "ivan.drizhiruk@ardas.dp.ua";
			
			processUIBuildStatesSection(states);
			processWSBuildStatesSection(states);
			processTESTSBuildStatesSection(states);
			
			$("#theOneWhoBrokeBuildName")[0].innerHTML = lastCommitter;

			if (isBuildFailed) {
				$(".brokenBuildSection").show();
				setTheOneWhoBrokeBuildPhoto(lastCommitterEmail);
			} else {
				$(".brokenBuildSection").hide();
				setTheOneWhoBrokeBuildPhoto(null);
			}
		}
		
		function processUIBuildStatesSection(states){
			if (null == states.UI || states.UI.state == "SUCCESS") {
				$('UIBuildStatus')[0].href = "images/successes.jpg";
			} else {
				$('UIBuildStatus')[0].href = "images/error.jpg";
			}
		}
		

		function processWSBuildStatesSection(states){
			if (null == states.UI || states.UI.state == "SUCCESS") {
				$('WSBuildStatus')[0].href = "images/successes.jpg";
			} else {
				$('WSBuildStatus')[0].href = "images/error.jpg";
			}
		}
		
		function processTESTSBuildStatesSection(states){
			/*
			images/warning.png
			*/
		}


		function setTheOneWhoBrokeBuildPhoto(email) {
			var element = $("#theOneWhoBrokeBuildPhoto");
			if (!email) {
				element.hide();
				return;
			}
			
			element[0].src = "http://www.gravatar.com/avatar/" + $.md5($.trim(email).toLowerCase()) + "?d=none&s=192";
		}

		
		/*
		
		function fillData() {
			$("#theOneWhoBrokeBuildName")[0].innerHTML = lastCommitter;
			initFailedCount($("#failednumT"), failedThucydidesCount);
			$("#passedlblT")[0].innerHTML = passedThucydidesCount;
			$("#pendinglblT")[0].innerHTML = pendingThucidydesCount;
			/*initFailedCount($("#failednumC"), failedCTestsCount);
			$("#passedlblC")[0].innerHTML = passedCTestsCount;
			initFailedCount($("#failednumW"), failedWsCount);
			$("#passedlblW")[0].innerHTML = passedWsCount;
			* /
			initBugSection($("#bugCriticalTitle"), $("#bugCriticalTotal"), $("#bugCriticalNotAssigned"), bugCriticalTotal, bugCriticalNotAssigned);
			initBugSection($("#bugHighTitle"), $("#bugHighTotal"), $("#bugHighNotAssigned"), bugHighTotal, bugHighNotAssigned);
			initBugSection($("#bugMediumTitle"), $("#bugMediumTotal"), $("#bugMediumNotAssigned"), bugMediumTotal, bugMediumNotAssigned);
			$("#thanksSection")[0].innerHTML = thanksVar;
		}
		
		function initFailedCount(element, value) {
			element[0].innerHTML = value;
			element.css('background', (0 == value) ? 'green' : '#e30613');
		}
		
		function initBugSection(titleElement, totalElement, contentElement, totalCount, notAssignedCount) {
			contentElement[0].innerHTML = getNumberOrUnknownSign(notAssignedCount);
			if (0 == notAssignedCount) {
				contentElement.hide();
			} else {
				contentElement.show();
			}
			titleElement.css('color', (0 == totalCount) ? 'green' : '#e30613');
			totalElement[0].innerHTML = getNumberOrUnknownSign(totalCount);
		}
		
		function setTheOneWhoBrokeBuildPhoto(email) {
			var element = $("#theOneWhoBrokeBuildPhoto");
			if (!email) {
				element.hide();
				return;
			}
			
			element[0].src = "http://www.gravatar.com/avatar/" + $.md5($.trim(email).toLowerCase()) + "?d=none&s=192";
		}
		*/
	</script>
	</head>

	<body onload="updateRadiator();">
		<div class="wrap">
			<header> </header>
			<nav></nav>
			<section>
				<article>
					<table>
						<tr class="thucydidesTestsSection">
							<td class="sectname shadow" colspan="3">Thucydides tests</td>
						</tr>
						<tr class="thucydidesTestsSection">
							<td class="sectcont"><span class="failedlbl">Failed:</span> <span
								class="passedlbl">Passed:</span> <span class="pendinglbl">Pending:</span>
							</td>
							<td class="sectcont" style="width: 100%; padding: 30px 0px;">
								<span id="failednumT" class="failednum"></span>
								<span id="passedlblT" class="passedlbl"></span>
								<span id="pendinglblT" class="pendinglbl"></span>
							</td>
							<td class="tdchart">
								<div id="thucydidesChart" class="chart"></div>
							</td>
						</tr>
						<tr class="thucydidesTestsSection">
							<td colspan="3">
								<br/>
								<br/>
								<br/>
							</td>
						</tr>
						<tr class="bugsSection">
							<td class="sectname shadow" colspan="3">Bugs</td>
						</tr>
						<tr class="bugsSection">
							<td class="sectcont" colspan="3" style="padding: 0;">
								<table style="text-align: center; width: 96%;">
									<tr>
										<td id="bugCriticalTitle" class="sectcont" style="color: #e30613;">
											Critical&nbsp;(<span id="bugCriticalTotal"></span>)
										</td>
										<td id="bugHighTitle" class="sectcont"">
											High&nbsp;(<span id="bugHighTotal"></span>)
										</td>
										<td id="bugMediumTitle" class="sectcont" style="color: #e30613;">
											Medium&nbsp;(<span id="bugMediumTotal"></span>)
										</td>
									</tr>
									<tr>
										<td><span id="bugCriticalInfo" class="failednum"></span></td>
										<td><span id="bugHighInfo" class="failednum"></span></td>
										<td><span id="bugMediumInfo" class="failednum"></span></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr class="bugsSection">
							<td class="sectname shadow" colspan="3">Build State</td>
						</tr>
						<tr class="BuildStatusSection">
							<td class="sectcont" colspan="3" style="padding: 0;">
								<table style="text-align: center; width: 96%;">
									<tr>
										<td class="sectcont" style="Width: 34%">
											UI
										</td>
										<td class="sectcont"  style="Width: 34%">
											WS
										</td>
										<td class="sectcont"  style="Width: 34%">
											TEST
										</td>
									</tr>
									<tr>
										<td class="sectcont" style="Width: 34%">
											<img id="UIBuildStatus" src="images/successes.jpg" class="buildStateImage"/>
										</td>
										<td class="sectcont"  style="Width: 34%">
											<img id="WSBuildStatus" src="images/successes.jpg"  class="buildStateImage"/>
										</td>
										<td class="sectcont"  style="Width: 34%">
											<img id="TESTSBuildStatus" src="images/successes.jpg"  class="buildStateImage"/>
										</td>
									</tr>
								</table>
							</td>
						</tr>
						<tr class="brokenBuildSection" style="display: none">
							<td class="sectcont badbuild" colspan="2" style="width: 100%;">
								ERROR_MSG <span id="theOneWhoBrokeBuildName" class="broker_name"></span>
							</td>
							<td class="tdchart">
								<span class="chart broker_foto">
									<div class="def_foto">
										<img id="theOneWhoBrokeBuildPhoto"/>
									</div>
								</span>
							</td>
						</tr>
						<tr class="thanksSection">
							<td id="thanksSection" class="thanks shadow" colspan="3"></td>
						</tr>
					</table>
				</article>
			</section>
			<div class="empty"></div>
		</div>
		<footer> </footer>
	</body>
	</html>
