<!doctype html>
<html lang="ua">
<head>
	<title>Activity Monitor</title>
	
	<meta charset="utf-8">
	<meta name="Author" content="Ardas Group" />
	
	<link rel="stylesheet" href="css/style.css">
	
	<script src="js/modernizr-1.7.min.js"></script>
	<script src="js/jquery-1.9.0.min.js"></script>
	<script src="js/jquery.json-2.4.min.js"></script>
	<script src="js/md5.min.js"></script>
	
	<script src="js/google_jsapi.js"></script>
	<script src="js/google_piechart.js"></script>
	
	<script type="text/javascript">
		var thucydidesChar;
		var thucydidesRestChar;
		
		$(document).ready(function() {
			thucydidesChart = new google.visualization.PieChart(document.getElementById('thucydidesChart'));
			thucydidesRestChar = new google.visualization.PieChart(document.getElementById('thucydidesRestChart'));
			
			updateRadiator();
			window.setInterval(updateRadiator, 5000);
		});
		
	
		function updateRadiator() {
			var repost = loadReport();
			
			if (null == repost) {
				return;
			}
			
			processThucydidesTestsSection(repost.thucydidesTestStaistic);
			processThucydidesRestTestsSection(repost.thucydidesRestTestStaistic);
			

			processSpiraTestStatisticSection(repost.spiraTestStatistics, repost.spiraTestOnStartWeekStatistics, repost.configuration);
			
			processBuildStatesSection(repost.buildStates);
			
			playSound(repost.configuration);
		}
		
		function loadReport() {
			 var jqXHR = $.ajax({
			        type: 'GET',
			        url: "rest/report",
			        dataType: "json",
			        cache: false,
			        async: false,
		            error: function(jqXHR, textStatus, errorThrown){
		                showError('Unable load report data. Status ' + textStatus);
		            },
					success: function(msg){
						clearError();
					}
			    });
			 try {
			 	return $.evalJSON(jqXHR.responseText);
			 } catch(e) {
				 return null;
			 }
		}

		
		function processThucydidesTestsSection(statistics) {
			if(!statistics) {
				$('#uiThucydidesTestsSection').hide();
				return;
			}
			var failed = statistics.failed + statistics.errors;

			initFailedCount($("#failednumT"), failed);
			$("#passedlblT")[0].innerHTML = statistics.passed;
			$("#pendinglblT")[0].innerHTML = statistics.pending;

			
			drawChart(statistics.passed, statistics.pending, failed, thucydidesChart);
		}
		
		function processThucydidesRestTestsSection(statistics) {
			if(!statistics) {
				$('#restThucydidesTestsSection').hide();
				return;
			}
			var failed = statistics.failed + statistics.errors;

			initFailedCount($("#failednumTRest"), failed);
			$("#passedlblTRest")[0].innerHTML = statistics.passed;
			$("#pendinglblTRest")[0].innerHTML = statistics.pending;

			
			drawChart(statistics.passed, statistics.pending, failed, thucydidesRestChar);
		}

		function drawChart(passed, pending, failed, chart) {
			var data = google.visualization.arrayToDataTable([
					[ 'Tests', 'Amount' ], [ , passed ], [ , pending ],
					[ , failed ] ]);

			var options = {
				width : 327,
				height : 327,
				chartArea : {
					width : "100%",
					height : "100%"
				},
				colors : [ '#00C000', '#FFB700', '#FF0000' ],
				legend : {
					position : 'none'
				},
				backgroundColor : 'none'
			};

			chart.draw(data, options);
		}
		
		function initFailedCount(element, value) {
			element[0].innerHTML = value;
			
			var color = (0 >= value
							? 'green'
							: '#e30613')
				
			element.css('background', color);
		}
		
		function processSpiraTestStatisticSection(statistics, statisticsOnWeekStart, configuration) {
			if(configuration && configuration['spira.test.disabled']) {
				$('.bugsSection').hide();
				return;
			}
			
			initBugSection($("#bugCriticalTitle"), $("#bugCriticalTotal"), $("#bugCriticalInfo"), statistics.high, statisticsOnWeekStart.high);
			initBugSection($("#bugHighTitle"), $("#bugHighTotal"), $("#bugHighInfo"), statistics.medium, statisticsOnWeekStart.medium);
			initBugSection($("#bugMediumTitle"), $("#bugMediumTotal"), $("#bugMediumInfo"), statistics.low, statisticsOnWeekStart.low);
		}
		
		function initBugSection(titleElement, totalElement, infoElement, totalCount, totalCountOnWeekStart) {
			

			initFailedCount(infoElement, totalCount-totalCountOnWeekStart);

			titleElement.css('color', (0 == totalCount) ? 'green' : '#e30613');
			totalElement[0].innerHTML = getNumberOrUnknownSign(totalCount);
		}

		function getNumberOrUnknownSign(num) {
			return -1 < num ? num : "?";
		}

		function processBuildStatesSection(states) {
			processBuildStatesSectionByInstance($('#UIBuildStatus')[0], states.UI);
			processBuildStatesSectionByInstance($('#WSBuildStatus')[0], states.WS);
			processBuildStatesSectionByInstance($('#NIGHTLYBuildStatus')[0], states.NIGHTLY);

			processTESTSBuildStatesSection(states);
		}
		
		function processBuildStatesSectionByInstance(parentElement, instanceStates){
			$(parentElement).empty();
			
			if (equelsStates(instanceStates,"SUCCESS")) {
				showImage(parentElement, "images/successes.jpg");
			} else if (equelsStates(instanceStates,"CONFIGURATION_FAILED")) {
				showImage(parentElement, "images/warning.png");
			} else {
				showPersonsWhoBrokeBuildPhoto(parentElement, instanceStates);
			}
		}

		function processTESTSBuildStatesSection(states){
			$('#TESTSBuildStatus').empty();
			
			if (equelsStates(states.UI_THUCYDIDES_TESTS3,"BUILD_FAILED")) {
				showPersonsWhoBrokeBuildPhoto($('#TESTSBuildStatus')[0], states.UI_THUCYDIDES_TESTS3);
				return;
			}
			
			if (equelsStates(states.UI_THUCYDIDES_TESTS1,"CONFIGURATION_FAILED")
					|| equelsStates(states.UI_THUCYDIDES_TESTS2,"CONFIGURATION_FAILED")
					|| equelsStates(states.UI_THUCYDIDES_TESTS3,"CONFIGURATION_FAILED")
					|| equelsStates(states.UI_THUCYDIDES_TESTS4,"CONFIGURATION_FAILED")) {
				showImage($('#TESTSBuildStatus')[0], "images/warning.png");
				return;
			}
			
			showImage($('#TESTSBuildStatus')[0], "images/successes.jpg");
		}
		
		function equelsStates(obj, state) {
			return (!obj || obj.state == state);
		}

		function showImage(parentElement, imageSrc) {
			var parent = $(parentElement); 
			parent.innerHTML = '';
			parent.append($('<img class="buildStateImage" src=' + imageSrc +' />'));
		}
		
		function showPersonsWhoBrokeBuildPhoto(parentElement, instance) {
			var parent = $(parentElement); 

			parent.innerHTML = '';
			console.log(instance.commiters);
			$.each(instance.commiters, function(index, person) {
					showPersonWhoBrokeBuildPhoto(parent, person);
				});
		}
		
		function showPersonWhoBrokeBuildPhoto(parent, person) {
			var div = $('<div class="badbuild" />');

			var imgSrc = "http://www.gravatar.com/avatar/"
				+ $.md5($.trim(person.email).toLowerCase())
				+ "?d=none&s=192";
			div.append('<span class="broker_foto">'
					+'<div class="def_foto">'
					+'<img src=' + imgSrc +' />'
					+'</div>'
					+'</span>');

			div.append('<span id="theOneWhoBrokeBuildName" class="broker_name">'
					+ person.name
					+ '</span>');

			parent.append(div);
		}
		
		
		function playSound(configuration) {
			if(configuration && configuration['play.sound.by.pathes']) {
				
				$.each( configuration['play.sound.by.pathes'],
					function( key, path ) {
						var audio = new Audio();
						audio.src = path;
						audio.play();
					});
			}
		}
		
		function showError(error) {
			$('#errorArea').show();
			$('#errorArea').html(error);
		}
		
		function clearError() {
			$('#errorArea').hide();
			$('#errorArea').html("");
		}
	</script>
</head>

	<body>
		<div class="wrap">
			<header> </header>
			<nav></nav>
			<section>
				<article>
					<div id="errorArea" style="display:none">
					</div>
					<table id="uiThucydidesTestsSection" class="mainTable">
						<tr class="thucydidesTestsSection">
							<td class="sectname shadow" colspan="3">Thucydides tests</td>
						</tr>
						<tr class="thucydidesTestsSection">
							<td class="sectcont"><span class="failedlbl">Failed:</span> <span
								class="passedlbl">Passed:</span> <span class="pendinglbl">Pending:</span>
							</td>
							<td class="sectcont" style="width: 100%; padding: 30px 0px;">
								<span id="failednumT" class="failednum"></span>
								<span id="passedlblT" class="passedlbl"></span>
								<span id="pendinglblT" class="pendinglbl"></span>
							</td>
							<td class="tdchart">
								<div id="thucydidesChart" class="chart"></div>
							</td>
						</tr>
						<tr class="thucydidesTestsSection">
							<td colspan="3">
								<br/>
								<br/>
								<br/>
							</td>
						</tr>
					</table>	
<!-- ********************************************************* -->
					<table id="restThucydidesTestsSection" class="mainTable">						
						<tr class="thucydidesRestTestsSection">
							<td class="sectname shadow" colspan="3">Thucydides Rest tests</td>
						</tr>
						<tr class="thucydidesTestsSection">
							<td class="sectcont"><span class="failedlbl">Failed:</span> <span
								class="passedlbl">Passed:</span> <span class="pendinglbl">Pending:</span>
							</td>
							<td class="sectcont" style="width: 100%; padding: 30px 0px;">
								<span id="failednumTRest" class="failednum"></span>
								<span id="passedlblTRest" class="passedlbl"></span>
								<span id="pendinglblTRest" class="pendinglbl"></span>
							</td>
							<td class="tdchart">
								<div id="thucydidesRestChart" class="chart"></div>
							</td>
						</tr>
						<tr class="thucydidesTestsSection">
							<td colspan="3">
								<br/>
								<br/>
								<br/>
							</td>
						</tr>
					</table>
<!-- ********************************************************* -->						
					<table class="mainTable">	
						<tr class="bugsSection">
							<td class="sectname shadow" colspan="3">Bugs</td>
						</tr>
						<tr class="bugsSection">
							<td class="sectcont" colspan="3" style="padding: 0;">
								<table style="text-align: center; width: 96%;">
									<tr>
										<td id="bugCriticalTitle" class="sectcont" style="color: #e30613;">
											Critical&nbsp;(<span id="bugCriticalTotal"></span>)
										</td>
										<td id="bugHighTitle" class="sectcont"">
											High&nbsp;(<span id="bugHighTotal"></span>)
										</td>
										<td id="bugMediumTitle" class="sectcont" style="color: #e30613;">
											Medium&nbsp;(<span id="bugMediumTotal"></span>)
										</td>
									</tr>
									<tr>
										<td><span id="bugCriticalInfo" class="failednum"></span></td>
										<td><span id="bugHighInfo" class="failednum"></span></td>
										<td><span id="bugMediumInfo" class="failednum"></span></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr class="buildStateSection">
							<td class="sectname shadow" colspan="3">Build State</td>
						</tr>
						<tr class="buildStatusSection">
							<td class="sectcont" colspan="3" style="padding: 0;">
								<table style="text-align: center; width: 96%;">
									<tr>
										<td class="sectcont" style="width: 34%;">
											UI
										</td>
										<td class="sectcont"  style="width: 34%;">
											WS
										</td>
									</tr>
									<tr>
										<td id="UIBuildStatus" class="sectcont" style="Width: 34%; vertical-align: top;" />
										<td id="WSBuildStatus" class="sectcont"  style="Width: 34%; vertical-align: top;" />
									</tr>
									<tr>																		<tr>
										<td class="sectcont"  style="width: 34%;">
											TEST
										</td>
										<td class="sectcont"  style="width: 34%;">
											NIGHTLY
										</td>
									</tr>
									<tr>
										<td id="TESTSBuildStatus" class="sectcont"  style="Width: 34%; vertical-align: top;" />
										<td id="NIGHTLYBuildStatus" class="sectcont"  style="Width: 34%; vertical-align: top;" />
									</tr>
								</table>
							</td>
						</tr>
					</table>
				</article>
			</section>
			<div class="empty"></div>
		</div>
		<footer> </footer>
	</body>
	</html>
